
--this script creates / alters a SQLCLR assembly
--it HAS to be run with sa permissions!!!!


SET NOCOUNT ON;

--the binary representation of WIKI.SqlClr.Rabbitmq (.NET 3.5)
DECLARE @AssemblyData VARBINARY(MAX)
SET @AssemblyData = 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C01030043B6205A0000000000000000E00022200B013000001A00000006000000000000EE3800000020000000400000000000100020000000020000040000000000000004000000000000000080000000020000000000000300408500001000001000000000100000100000000000001000000000000000000000009C3800004F00000000400000D802000000000000000000000000000000000000006000000C000000643700001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000F418000000200000001A000000020000000000000000000000000000200000602E72737263000000D80200000040000000040000001C0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000002000000000000000000000000000004000004200000000000000000000000000000000D0380000000000004800000002000500542500001012000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B30030083000000010000110002281B0000060A0614FE010C082C1900280700000A720100007002280800000A6F0900000A002B59066F1700000616FE010D092C1900280700000A723300007002280800000A6F0900000A002B33190B00000603281D00000600DE251304000717590B0716FE0216FE01130511052C0311047A00DE00000716FE02130611062DCF2A0001100000000052000B5D001A070000012202280A00000A002A1E027B010000042A2202037D010000042A1E027B020000042A2202037D020000042A1E027B030000042A2202037D030000042A1E027B040000042A2202037D040000042A1E027B050000042A2202037D050000042A1E027B060000042A2202037D060000042A1E027B070000042A2202037D070000042A1E027B080000042A2202037D080000042A1E027B090000042A2202037D090000042A1E027B0A0000042A2202037D0A0000042A1E027B0B0000042A2202037D0B0000042A13300400C50000000000000002280A00000A00000203166F0B00000A2804000006000203176F0C00000A2806000006000203186F0C00000A2808000006000203196F0B00000A280A0000060002031A6F0C00000A280C0000060002280D00000A031B6F0E00000A740100001B6F0F00000A280E0000060002031C6F0C00000A28100000060002031D6F0C00000A28120000060002031E6F0E00000A7E1000000A3303142B07031E6F0C00000A28140000060002031F096F0C00000A28160000060002031F0A6F1100000A2818000006002A000000133005007C000000020000110072630000701F0A8D050000012516022805000006A22517022807000006A225180228090000068C17000001A2251902280B000006A2251A02280D000006A2251B02280F000006A2251C022811000006A2251D022813000006A2251E022815000006A2251F090228170000068C18000001A2281200000A0A2B00062A1B300200850000000300001100140A0072AC01007002280800000A0B723F020070731300000A0C00086F1400000A000708731500000A0D096F1600000A130411046F1700000A130511052C1C002B0B00110473190000060A2B0D11046F1800000A130611062DE80000DE0B082C07086F1900000A00DC00DE1013070011076F1A00000A731B00000A7A0613082B0011082A000000011C000002001B00445F000B00000000000003006A6D0010070000011B300600530100000400001100731C00000A25026F070000067D1D00000A25026F090000067D1E00000A25026F0B0000066F1F00000A0025026F0D0000066F2000000A000A066F2100000A0B076F2200000A0C00026F0F000006282300000A2D08026F0F0000062B0572730200700D026F11000006282300000A2D08026F110000062B0572730200701304026F13000006282300000A2D08026F130000062B0572730200701305026F15000006282300000A2D08026F150000062B057273020070130611067273020070282400000A130811082C1108026F15000006171616146F2500000A26097273020070282400000A130911092C2D00080911047273020070282600000A2D0411042B0572750200706F2700000A000811060911056F2800000A00007283020070282900000A036F2A00000A1307080911051411076F2B00000A0000DE0B082C07086F1900000A00DCDE0B072C07076F1900000A00DC2A00413400000200000047000000F30000003A0100000B00000000000000020000004000000007010000470100000B0000000000000042534A4201000100000000000C00000076322E302E35303732370000000005006C000000F0060000237E00005C070000B006000023537472696E6773000000000C0E00009402000023555300A0100000100000002347554944000000B01000006001000023426C6F6200000000000000020000015715A2090900000000FA013300160000010000001E000000050000000B0000001E000000110000002B0000003000000004000000010000000B000000160000000100000001000000030000000000560401000000000006007B037B0506009B037B050600360368050F009B0500000600E8057F040A00650347050600D9047F0406001B037B0506000403680506004A0368050A001B05FF050A00C004FF050A00A101FF050E007406EF050E009604EF050E004304EF050A004B0647050A00AC024705060003047F040A000E05E3040600EE033F0606006F047F04060004007F04060089047F040A00A204E30406001E027F040600CE047F040E003404EF0506000A0036000E00AA05EF05000000001800000000000100010001001000BB050000150001000100000010001506F60415000100030000001000F302F60415000C001B00000010003705F60415000C001D00010080009D0001001F019A00010003019A0001006F019D000100E8009A000100AF009A000100CE009A0001003A019A00010085019A00010058019A0001009400F00050200000000096001204F3000100F020000000008618620506000300F9200000000086085100F900030001210000000086085800010003000A2100000000860871028500040012210000000086087F022D0004001B21000000008608530285000500232100000000860862022D0005002C210000000086082D06F900060034210000000086083606010006003D210000000086082A0285000700452100000000860838022D0007004E21000000008608C801850008005621000000008608DA012D0008005F21000000008608040285000900672100000000860811022D0009007021000000008608B40285000A007821000000008608C5022D000A008121000000008608560685000B00892100000000860865062D000B009221000000008608B90385000C009A21000000008608C3032D000C00A321000000008608640081000D00AB210000000086087200FD000D00B421000000008318620502010E00882200000000C600F70385000F001023000000009300D90308010F00F020000000008618620506001000C0230000000093000A040E011000F020000000008618620506001200000001008D0200000200230400000100D30300000100D30300000100D30300000100D30300000100D30300000100D30300000100D30300000100D30300000100D30300000100D30300000100D303000001000B05000001008D02000001002406000002002304090062050100110062050600190062050A003100620506004100620506005100620510008900A30222009900E10527009100AC012D00290062050600A10001003200A10000043700A900EC013C00A10076044100A90000044900B100CD034F00A100860453009900E1055C00610062052D00C90091040600690062057500690029057C00A100D5058100A1005F008100D100FC0206003900F8018500D90062052D0071006205060071009A029A0071003A069D00710046022D007100BB012D007100AF04A00079004A04A5009900A006AA0099009206AF008100E602B50099008606AF008100D602C4008100B101CA00A900EB03D100A900CC05D70081002704DD0020002300520121002B0052012100330057012E000B0021012E0013002A012E001B00490141002B00520141003300570160002B00520161002B00520161003300570180002B00520181002B005201810033005701A0002B005201A1002B005201A10033005701C0002B005201C1002B005201C10033005701E0002B005201E1002B005201E1003300570100012B00520101012B00520101013300570120012B00520121012B00520121013300570140012B00520141012B00520141013300570160012B00520161012B00520161013300570180012B005201A0012B005201C0012B005201E0012B00520100022B00520120022B00520140022B00520160022B00520180022B005201A0022B005201C0022B005201E0022B00520100032B00520116005800630089000300010000005C00150100008302190100006602190100003A06150100003C0219010000DE0119010000150219010000C90219010000690619010000C7031901000076001D0102000300030001000400030002000500050001000600050002000700070001000800070002000900090001000A00090002000B000B0001000C000B0002000D000D0001000E000D0002000F000F00010010000F000200110011000100120011000200130013000100140013000200150015000100160015000200170017000100180017004600048000000000000000000000000000000000F6040000020000000000000000000000E7002D0000000000020000000000000000000000E7002100000000000000000000000000000000000000EF05000000000000000000476574496E743332004944696374696F6E6172796032003C4D6F64756C653E0053797374656D2E44617461006D73636F726C69620053797374656D2E436F6C6C656374696F6E732E47656E65726963006765745F4964007365745F49640052656164006765745F4973456E61626C6564007365745F4973456E61626C6564003C49643E6B5F5F4261636B696E674669656C64003C4973456E61626C65643E6B5F5F4261636B696E674669656C64003C4C6F67696E50617373776F72643E6B5F5F4261636B696E674669656C64003C45786368616E67653E6B5F5F4261636B696E674669656C64003C4C6F67696E4E616D653E6B5F5F4261636B696E674669656C64003C5365727665724E616D653E6B5F5F4261636B696E674669656C64003C416C6961734E616D653E6B5F5F4261636B696E674669656C64003C45786368616E6765547970653E6B5F5F4261636B696E674669656C64003C51756575653E6B5F5F4261636B696E674669656C64003C506F72743E6B5F5F4261636B696E674669656C64003C526F7574696E674B65793E6B5F5F4261636B696E674669656C640053716C436F6D6D616E640053656E6400517565756542696E64007365745F50617373776F7264006765745F4C6F67696E50617373776F7264007365745F4C6F67696E50617373776F7264006765745F556E69636F6465006765745F4D657373616765006765745F45786368616E6765007365745F45786368616E67650049446973706F7361626C65006765745F4C6F67696E4E616D65007365745F4C6F67696E4E616D65007365745F557365724E616D65006765745F5365727665724E616D65007365745F5365727665724E616D65006765745F416C6961734E616D65007365745F416C6961734E616D6500656E64706F696E744E616D6500486F73744E616D65006765745F506970650053716C50697065006765745F45786368616E676554797065007365745F45786368616E6765547970650045786368616E67654465636C6172650051756575654465636C61726500446174616261736500446973706F736500446562756767657242726F777361626C65537461746500436F6D70696C657247656E6572617465644174747269627574650044656275676761626C6541747472696275746500446562756767657242726F777361626C654174747269627574650053716C50726F63656475726541747472696275746500436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465006765745F5175657565007365745F51756575650056616C75650076616C756500476574456E64706F696E74436F6E66696700476574456E636F64696E6700546F537472696E6700476574537472696E670053656E644D73670073705F506F73745261626269744D7367006D73670042617369635075626C6973680051756575654465636C6172654F6B00494D6F64656C004372656174654D6F64656C0057494B492E53716C436C722E5261626269746D712E646C6C0044424E756C6C006765745F4974656D0053797374656D00476574426F6F6C65616E004F70656E0049436F6E6E656374696F6E004462436F6E6E656374696F6E00437265617465436F6E6E656374696F6E0053716C436F6E6E656374696F6E004170706C69636174696F6E457863657074696F6E0053797374656D2E446174612E436F6D6D6F6E0057494B492E53716C436C722E5261626269746D71006472004462446174615265616465720053716C446174615265616465720045786563757465526561646572005261626269745075626C6973686572004D6963726F736F66742E53716C5365727665722E536572766572002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730049426173696350726F706572746965730053746F72656450726F63656475726573004765744279746573006765745F486173526F777300466F726D6174004F626A656374005261626269744D512E436C69656E740053797374656D2E446174612E53716C436C69656E7400526162626974456E64706F696E7400656E64706F696E74006765745F506F7274007365745F506F72740053797374656D2E546578740053716C436F6E74657874006765745F526F7574696E674B6579007365745F526F7574696E674B657900436F6E6E656374696F6E466163746F7279006F705F457175616C697479006F705F496E657175616C6974790049734E756C6C4F72456D707479000000003145006E00640070006F0069006E0074003A0020007B0030007D002C0020004E006F007400200046006F0075006E006400002F45006E00640070006F0069006E0074003A0020007B0030007D002C002000440069007300610062006C00650064000081470D000A0041006C006900610073004E0061006D0065003A0020007B0030007D000D000A005300650072007600650072004E0061006D0065003A0020007B0031007D002C0020000D000A0050006F00720074003A0020007B0032007D002C0020000D000A004C006F00670069006E004E0061006D0065003A0020007B0033007D000D000A00500061007300730077006F00720064003A0020007B0034007D002C000D000A00450078006300680061006E00670065003A0020007B0035007D002C000D000A00450078006300680061006E006700650054007900700065003A0020007B0036007D002C000D000A0052006F007500740069006E0067004B00650079003A0020007B0037007D002C000D000A00510075006500750065003A0020007B0038007D002C000D000A004900730045006E00610062006C00650064003A0020007B0039007D00008091730065006C0065006300740020002A002000660072006F006D00200072006D0071002E00740062005F0052006100620062006900740045006E00640070006F0069006E0074002000770069007400680028006E006F006C006F0063006B002900200077006800650072006500200041006C006900610073004E0061006D00650020003D00200027007B0030007D002700013343006F006E007400650078007400200043006F006E006E0065006300740069006F006E0020003D00200074007200750065000001000D640069007200650063007400000D67006200320033003100320000000000CC7894C9AB7E434D9DBDA5DAB611DE7A000420010108032000010520010111110520010111250B0707120C080202121D020204000012490500020E0E1C042001010E04200108080420010E0804000012550420011C08021D050520010E1D050306125904200102080307010E0600020E0E1D1C110709120C0E12311235122D0202121D120C062002010E1231042000122D032000020320000E10070A1239123D12410E0E0E0E1D05020202060E020608042000123D0420001241040001020E050002020E0E0E200512710E020202151275020E1C052002010E0E062003010E0E0E05000112550E0520011D050E092004010E0E12791D0508B77A5C561934E089020602050002010E0E03200008042001010205200101122D050001120C0E06000201120C0E032800080328000E032800020801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F77730108010007010000000004010000000801000000000000000000000043B6205A00000000020000001C010000803700008019000052534453ACDAD5502AE05148A80FE37DEB99CB0D01000000433A5C55736572735C44465C576F726B73706163655C776471685C575042535C57696B695C656C6B5C7372635C57494B492E53716C436C722E5261626269746D715C6F626A5C44656275675C57494B492E53716C436C722E5261626269746D712E70646200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000C43800000000000000000000DE380000002000000000000000000000000000000000000000000000D0380000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000007C02000000000000000000007C0234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000000000000000000000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004DC010000010053007400720069006E006700460069006C00650049006E0066006F000000B801000001003000300030003000300034006200300000002C0002000100460069006C0065004400650073006300720069007000740069006F006E000000000020000000300008000100460069006C006500560065007200730069006F006E000000000030002E0030002E0030002E003000000052001900010049006E007400650072006E0061006C004E0061006D0065000000570049004B0049002E00530071006C0043006C0072002E005200610062006200690074006D0071002E0064006C006C00000000002800020001004C006500670061006C0043006F0070007900720069006700680074000000200000005A00190001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000570049004B0049002E00530071006C0043006C0072002E005200610062006200690074006D0071002E0064006C006C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000F03800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

--the following name needs also to be used (without single-quotes)
-- in the CREATE and ALTER statements below
DECLARE @asmName sysname = 'WIKI.SqlClr.Rabbitmq';

--end setting parameters

DECLARE @dbname nvarchar(256);
DECLARE @isTrustworthy bit;
DECLARE @alterStmt nvarchar(512);
DECLARE @isCLREnabled int;
DECLARE @isCreateAlter bit = 0;
DECLARE @spConfigureTab TABLE (name varchar(256), minimum int, maximum int, config_value int, run_value int)


--check if clr is enabled, if not return out - as it cannot be done dynamically
INSERT INTO @spConfigureTab
EXEC sp_Configure 'CLR Enabled'

SELECT @isCLREnabled = run_value
FROM @spConfigureTab

IF(@isCLREnabled = 0)
BEGIN
  RAISERROR('CLR is not enabled on this db server. To enable, execute "sp_configure ''CLR Enabled'', 1 GO RECONFIGURE GO". This script now exits.', 16, -1)
  RETURN;
END

--check if we are trustworthy
SELECT @dbname = name, @isTrustworthy = is_trustworthy_on 
FROM sys.databases
WHERE name = db_name()

IF (@isTrustworthy = 0)
BEGIN
  SET @alterStmt = 'ALTER DATABASE ' + @dbname + ' SET TRUSTWORTHY ON;'
  EXEC( @alterStmt);
END

IF NOT EXISTS (SELECT * FROM sys.assemblies asms WHERE asms.name = @asmName)
BEGIN

  CREATE ASSEMBLY [WIKI.SqlClr.Rabbitmq]
  AUTHORIZATION rmq
  FROM @AssemblyData
  WITH PERMISSION_SET = UNSAFE;  	

END  
ELSE
BEGIN
  
  IF NOT EXISTS(SELECT 1 FROM sys.assembly_files WHERE content = @AssemblyData)
  BEGIN
  
    ALTER ASSEMBLY [WIKI.SqlClr.Rabbitmq]
    FROM @AssemblyData
    WITH PERMISSION_SET = UNSAFE;

  END
  ELSE
  BEGIN
    PRINT 'The assembly already exists. It is not being altered.'
  END
  
END
GO




IF EXISTS(SELECT 1 FROM sys.procedures WHERE object_id = OBJECT_ID('rmq.sp_PostRabbitMsg'))
BEGIN
  DROP PROCEDURE rmq.sp_PostRabbitMsg;
END
GO

CREATE PROCEDURE rmq.sp_PostRabbitMsg @endpointName nvarchar(128), @msg nvarchar(max)
AS
EXTERNAL NAME [WIKI.SqlClr.Rabbitmq].[StoredProcedures].[sp_PostRabbitMsg];
GO





